# Penetration Test Results Analysis (2026-01-21)

**Date:** 2026-01-21
**Status:** ‚ö†Ô∏è PARTIAL FIX (Critical vulnerabilities identified and patched, verification pending)

---

## 1. Summary of Failures & Root Causes

### üî¥ Critical: Replay Protection Failure (Test 8)
**Symptom:** Replay attacks on `/v1/enrollment/store` and `/v1/names/validate` succeeded (returned status 200/400 instead of 403).
**Root Cause:** The `replayProtection` middleware was defined but **not applied** to the `enrollment` or `names` routers in `server.js`. The routes were unprotected against nonce reuse.
**Fix Applied:** Applied `createReplayProtection()` to `/v1/enrollment`, `/v1/verification`, and `/v1/names` in `server.js`.

### üî¥ Critical: SSRF Vulnerability (Test 13)
**Symptom:** Access to `http://169.254.169.254` (AWS metadata) was possible via `/v1/names/resolve/:name`.
**Root Cause:** The `ssrfProtection` middleware was applied via `router.use()` at the top of `namesRouter.js`. In Express, `req.params` is not populated in global router middleware for path parameters defined in sub-routes. The validation logic ran on empty parameters, bypassing the check.
**Fix Applied:** Moved `strictSSRFProtection` middleware to be **inline** on the specific route definitions (`router.get('/resolve/:name', strictSSRFProtection, ...)`), ensuring `req.params.name` is populated before validation.

### üü° High: Rate Limiting Denial of Service (Tests 15, 21)
**Symptom:** Valid automated tests (Timing Attack, Role Matrix) failed with `429 Too Many Requests`.
**Root Cause:** Default IP rate limit was set to **100 req/min**, which is too low for automated security scanning.
**Fix Applied:** Updated `server.js` to dynamically set `ipRateLimit` to **1000 req/min** when `NODE_ENV=test` or `ENVIRONMENT=sandbox`.

### üü† Medium: Static Analysis False Positives (Tests 16, 18)
**Symptom:** 23,000+ issues found in Secret Scan.
**Root Cause:** Scanners were analyzing `node_modules`, build artifacts (`*.map`), and log files (`bugster_output.json`).
**Fix Applied:** Updated ignore lists in `16-secret-scan.py` and `18-weak-crypto.py` to exclude `dist`, `public`, `logs`, and specific JSON/map files.

---

## 2. Verification Plan

1. **Re-run Replay Test:** Verify `/v1/enrollment/store` returns `403 NONCE_ALREADY_USED` on replay.
2. **Re-run SSRF Test:** Verify `/v1/names/resolve/http...` returns `400 SSRF_PROTECTION`.
3. **Re-run Role Matrix:** Verify tests pass without `429` errors.

## 3. Next Steps

- **Deploy:** Push fixes to staging environment.
- **Retest:** Execute full suite again on staging.
- **Monitor:** Watch Redis for `REPLAY_ATTACK_DETECTED` logs.
