# Security Notes & Decisions

**Date:** 2026-01-21
**Author:** Claude Code

## Android Manifest: Exported Activities

### 1. `MainActivity` (com.zeropay.demo.MainActivity)
- **Status:** `exported="true"`
- **Reason:** Required to handle deep links from external wallet apps (e.g., Phantom Wallet callback).
- **Intent Filter:**
  ```xml
  <data android:scheme="notap" android:host="wallet" android:path="/callback" />
  ```
- **Risk:** Malicious apps could trigger this intent with fake `signature` parameters.
- **Mitigation (Future):**
  - Implement strict `nonce` or `state` validation in `handleWalletCallback()`.
  - Ensure the callback URL contains a unique, time-bound token generated by `WalletConnectionActivity`.
  - Verify the token matches the session state before accepting the wallet address.

### 2. `MerchantActivity` (com.zeropay.merchant.MerchantActivity)
- **Status:** `exported="true"`
- **Reason:** This is the main entry point (Launcher) for the Merchant App functionality.
- **Risk:** Low. It is a standard launcher activity.

## Frontend XSS Remediation

### Problem
The `online-web` module used `innerHTML` for dynamic content updates, creating potential XSS vectors if user input (e.g., voice transcript, custom error messages) contained HTML tags.

### Solution Pattern
Refactored to use `kotlinx.html` DSL for safe DOM manipulation.

**Before (Vulnerable):**
```kotlin
feedback.innerHTML = """<span class="error">${validation.message}</span>"""
```

**After (Secure):**
```kotlin
feedback.innerHTML = "" // Clear
feedback.append {
    span(classes = "error") {
        +validation.message // Automatically escaped
    }
}
```

### Applied To
- `VoiceCanvas.kt` (User input transcript)
- `PinCanvas.kt` (Validation feedback)
- `PatternCanvas.kt` (Validation feedback)

### Pending
- Remaining canvases (`Emoji`, `Color`, `Words`, etc.) should be refactored following this pattern.
